{% extends "base.html" %}

{% block title %}Dashboard - Fichaje de Empleados{% endblock %}

{% block extra_css %}
<style>
    .header-section {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        margin-bottom: 30px;
    }
    .header-section h2 {
        margin: 0;
        color: #2c3e50;
        font-weight: 600;
    }
    .filters-bar {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        margin-bottom: 20px;
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        align-items: center;
    }
    .filters-bar select, .filters-bar input {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 8px 15px;
    }
    .employee-table {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        overflow: hidden;
    }
    .table {
        margin: 0;
    }
    .table thead {
        background-color: #f8f9fa;
    }
    .table th {
        border: none;
        color: #6c757d;
        font-weight: 600;
        font-size: 0.85rem;
        text-transform: uppercase;
        padding: 15px;
    }
    .table td {
        border-top: 1px solid #f0f0f0;
        padding: 15px;
        vertical-align: middle;
    }
    .employee-info {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .employee-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
    }
    .employee-name {
        font-weight: 600;
        color: #2c3e50;
        margin: 0;
    }
    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 500;
    }
    .status-online {
        background-color: #d4edda;
        color: #155724;
    }
    .status-online::before {
        content: '';
        width: 8px;
        height: 8px;
        background-color: #28a745;
        border-radius: 50%;
    }
    .progress-bar-custom {
        height: 8px;
        border-radius: 4px;
        background-color: #e9ecef;
        position: relative;
        overflow: hidden;
    }
    .progress-fill {
        height: 100%;
        border-radius: 4px;
        transition: width 0.3s;
    }
    .time-display {
        font-size: 0.9rem;
        color: #6c757d;
    }
    .task-badge {
        background-color: #e9ecef;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.85rem;
        color: #495057;
    }
    .completion-text {
        font-weight: 600;
        color: #2c3e50;
    }
</style>
{% endblock %}
{% block content %}
<div class="header-section">
    <h2>Empleados</h2>
</div>

<div class="filters-bar">
    <select class="form-select" style="width: auto;">
        <option>Centro</option>
    </select>
    <select class="form-select" style="width: auto;">
        <option>Departamento</option>
    </select>
    <button class="btn btn-light">
        <i class="bi bi-three-dots-vertical"></i>
    </button>
    <input type="search" class="form-control" placeholder="Buscar" style="max-width: 300px; margin-left: auto;">
    <button class="btn btn-outline-secondary">Configuraci√≥n gr√°f.</button>
</div>

<div class="employee-table">
    <table id="tablaEmpleados" class="table table-bordered table-striped">
        <thead class="table-dark">
            <tr>
                <th>Nombre</th>
                <th>DNI</th>
                <th>Email</th>
                <th>Jornada</th>
                <th>Progreso</th>
                <th>Estado</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td colspan="5" class="text-center text-muted">Cargando empleados...</td>
            </tr>
        </tbody>
    </table>
</div>

<script>
let versionActual = 0;
let esperandoCambios = false;

// Funci√≥n para limpiar la fila vac√≠a
function limpiarFilaVacia() {
    const tbody = document.querySelector("#tablaEmpleados tbody");
    if (tbody && tbody.children.length === 1 &&
        tbody.children[0].children[0] &&
        tbody.children[0].children[0].colSpan === 5) {
        tbody.innerHTML = "";
    }
}

// Funci√≥n para agregar un empleado NUEVO
function agregarEmpleado(nombre,dni, email, jornada, horas, estado) {
    console.log(`[UI] ‚ûï Agregando empleado: ${nombre}`);
    limpiarFilaVacia();
    const tbody = document.querySelector("#tablaEmpleados tbody");
    if (!tbody) {
        console.error('[UI] ‚ùå No se encontr√≥ tbody');
        return;
    }

    const fila = document.createElement("tr");
    fila.setAttribute('data-email', email);
    
    const progreso = Math.min((horas / jornada) * 100, 100).toFixed(1);
    
    const colores = {
        "trabajando": "yellow",
        "out": "red",
        "completado": "green"
    };
    const color = colores[estado] || "gray";

    fila.innerHTML = `
        <td>${nombre}</td>
        <td>${dni}</td>
        <td>${email}</td>
        <td>${jornada}</td>
        <td>
            <div style="width:100%; background:#e5e5e5; border-radius:6px;">
                <div style="width:${progreso}%; height:12px; background:#007bff; border-radius:6px;"></div>
            </div>
            <small>${horas}/${jornada} h</small>
        </td>
        <td><span style="display:inline-block;width:16px;height:16px;background:${color};border-radius:50%;border:1px solid #555;"></span></td>
    `;
    tbody.appendChild(fila);
    console.log(`[UI] ‚úÖ Empleado agregado a la tabla: ${nombre}`);
}

// Funci√≥n para actualizar un empleado EXISTENTE
function actualizarEmpleado(email, horas, estado) {
    console.log(`[UI] üîÑ Actualizando empleado: ${email}`);
    const fila = document.querySelector(`tr[data-email="${email}"]`);
    if (!fila) {
        console.warn(`[UI] ‚ö†Ô∏è Empleado ${email} no encontrado en tabla`);
        return;
    }

    const jornada = parseFloat(fila.cells[2].textContent);
    const progreso = Math.min((horas / jornada) * 100, 100).toFixed(1);
    
    fila.cells[3].innerHTML = `
        <div style="width:100%; background:#e5e5e5; border-radius:6px;">
            <div style="width:${progreso}%; height:12px; background:#007bff; border-radius:6px;"></div>
        </div>
        <small>${horas}/${jornada} h</small>
    `;
    
    const colores = {
        "trabajando": "yellow",
        "out": "red",
        "completado": "green"
    };
    const color = colores[estado] || "gray";
    
    fila.cells[4].innerHTML = `<span style="display:inline-block;width:16px;height:16px;background:${color};border-radius:50%;border:1px solid #555;"></span>`;
    
    console.log(`[UI] ‚úÖ Empleado actualizado: ${email} - ${horas}h - ${estado}`);
}

// Cargar TODOS los empleados al inicio
async function cargarEmpleadosInicial() {
    console.log('[CLIENTE] üöÄ Cargando empleados iniciales...');
    try {
        const response = await fetch('/api/empleados');
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        console.log('[CLIENTE] üì¶ Datos recibidos:', data);
        
        if (data.success) {
            const tbody = document.querySelector("#tablaEmpleados tbody");
            tbody.innerHTML = '';
            
            if (data.empleados.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-muted">No hay empleados registrados a√∫n...</td>
                    </tr>
                `;
            } else {
                data.empleados.forEach(emp => {
                    agregarEmpleado(emp.nombre, emp.dni, emp.email, emp.jornada, emp.horas, emp.estado);
                });
            }
            
            versionActual = data.version;
            console.log(`[CLIENTE] ‚úÖ Empleados iniciales cargados. Versi√≥n: ${versionActual}`);
            
            // Iniciar long polling
            console.log('[CLIENTE] üîÑ Iniciando long polling...');
            esperarCambios();
        }
    } catch (error) {
        console.error('[CLIENTE] ‚ùå Error al cargar empleados:', error);
        setTimeout(cargarEmpleadosInicial, 3000);
    }
}

// Long polling: esperar cambios
async function esperarCambios() {
    if (esperandoCambios) {
        console.warn('[CLIENTE] ‚ö†Ô∏è Ya hay una petici√≥n activa');
        return;
    }
    esperandoCambios = true;
    
    console.log(`[CLIENTE] üì° Esperando cambios... (versi√≥n: ${versionActual})`);
    
    try {
        const response = await fetch(`/api/empleados/esperar-cambios?version=${versionActual}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        console.log('[CLIENTE] üì• Response status:', response.status);
        console.log('[CLIENTE] üì• Response ok:', response.ok);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        console.log('[CLIENTE] üì¶ Respuesta recibida:', data);
        console.log('[CLIENTE] üì¶ success:', data.success);
        console.log('[CLIENTE] üì¶ cambio:', data.cambio);
        console.log('[CLIENTE] üì¶ tipo:', data.tipo);
        console.log('[CLIENTE] üì¶ empleado:', data.empleado);
        
        if (data.success && data.cambio) {
            console.log(`[CLIENTE] üîî ¬°Cambio detectado! Tipo: ${data.tipo}`, data.empleado);
            
            versionActual = data.version;
            
            // Procesar seg√∫n el tipo de cambio
            if (data.tipo === 'nuevo') {
                const emp = data.empleado;
                console.log('[CLIENTE] ‚ûï Procesando empleado nuevo:', emp);
                agregarEmpleado(emp.nombre, emp.dni, emp.email, emp.jornada, emp.horas, emp.estado);
            } else if (data.tipo === 'actualizado') {
                const emp = data.empleado;
                console.log('[CLIENTE] üîÑ Procesando actualizaci√≥n:', emp);
                actualizarEmpleado(emp.email, emp.horas, emp.estado);
            }
        } else {
            console.log('[CLIENTE] ‚è∞ Sin cambios (timeout)');
        }
    } catch (error) {
        console.error('[CLIENTE] ‚ùå Error en long polling:', error);
        console.error('[CLIENTE] ‚ùå Error stack:', error.stack);
        await new Promise(resolve => setTimeout(resolve, 3000));
    } finally {
        esperandoCambios = false;
        // Volver a esperar cambios
        console.log('[CLIENTE] üîÅ Reactivando long polling...');
        setTimeout(() => esperarCambios(), 100);
    }
}

// Iniciar al cargar la p√°gina
console.log('[CLIENTE] üé¨ Iniciando dashboard...');
cargarEmpleadosInicial();
</script>

{% endblock %}
