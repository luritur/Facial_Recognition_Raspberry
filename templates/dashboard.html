{% extends "base.html" %}

{% block title %}Dashboard - Fichaje de Empleados{% endblock %}

{% block extra_css %}
<style>
    .header-section {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        margin-bottom: 30px;
    }
    .header-section h2 {
        margin: 0;
        color: #2c3e50;
        font-weight: 600;
    }
    .filters-bar {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        margin-bottom: 20px;
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        align-items: center;
    }
    .filters-bar select, .filters-bar input {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 8px 15px;
    }
    .employee-table {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        overflow: hidden;
    }
    .table {
        margin: 0;
    }
    .table thead {
        background-color: #f8f9fa;
    }
    .table th {
        border: none;
        color: #6c757d;
        font-weight: 600;
        font-size: 0.85rem;
        text-transform: uppercase;
        padding: 15px;
    }
    .table td {
        border-top: 1px solid #f0f0f0;
        padding: 15px;
        vertical-align: middle;
    }
    .employee-info {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .employee-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
    }
    .employee-name {
        font-weight: 600;
        color: #2c3e50;
        margin: 0;
    }
    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 500;
    }
    .status-online {
        background-color: #d4edda;
        color: #155724;
    }
    .status-online::before {
        content: '';
        width: 8px;
        height: 8px;
        background-color: #28a745;
        border-radius: 50%;
    }
    
    /* Animaci√≥n para cambios de estado */
    .estado-indicator {
        display: inline-block;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        border: 1px solid #555;
        transition: background-color 0.5s ease, transform 0.3s ease;
    }
    
    .estado-indicator.changed {
        animation: pulse 0.6s ease-in-out;
    }
    
    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.3); }
    }
</style>
{% endblock %}

{% block content %}
<div class="header-section">
    <h2>Empleados</h2>
</div>

<div class="employee-table">
    <table id="tablaEmpleados" class="table table-bordered table-striped">
        <thead class="table-dark">
            <tr>
                <th>Nombre</th>
                <th>DNI</th>
                <th>Email</th>
                <th>Jornada</th>
                <th>Estado</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td colspan="5" class="text-center text-muted">Cargando empleados...</td>
            </tr>
        </tbody>
    </table>
</div>

<script>
let versionActual = 0;
let esperandoCambios = false;
//let lastEmpleadosVersion = null;  // Variable para polling de estados

// Funci√≥n para limpiar la fila vac√≠a
function limpiarFilaVacia() {
    const tbody = document.querySelector("#tablaEmpleados tbody");
    if (tbody && tbody.children.length === 1 &&
        tbody.children[0].children[0] &&
        tbody.children[0].children[0].colSpan >= 5) {
        tbody.innerHTML = "";
    }
}

// Funci√≥n para obtener el color seg√∫n el estado
function obtenerColorEstado(estado) {
    const colores = {
        "trabajando": "#ffc107",  // Amarillo
        "in": "#ffc107",          // Amarillo (alias)
        "out": "#dc3545",         // Rojo
        "completado": "#28a745",  // Verde
        "completada": "#28a745"   // Verde (alias)
    };
    return colores[estado] || "#6c757d"; // Gris por defecto
}

// Funci√≥n para agregar un empleado NUEVO
function agregarEmpleado(nombre, dni, email, jornada, horas, estado) {
    console.log(`[UI] ‚ûï Agregando empleado: ${nombre}`);
    limpiarFilaVacia();
    const tbody = document.querySelector("#tablaEmpleados tbody");
    if (!tbody) {
        console.error('[UI] ‚ùå No se encontr√≥ tbody');
        return;
    }

    const fila = document.createElement("tr");
    fila.setAttribute('data-dni', dni);
    fila.setAttribute('data-email', email);
    const color = obtenerColorEstado(estado);

    fila.innerHTML = `
        <td>${nombre}</td>
        <td>${dni}</td>
        <td>${email}</td>
        <td>${jornada}h</td>
        <td>
            <span class="estado-indicator" data-estado="${estado}" style="background:${color};"></span>
        </td>
    `;
    tbody.appendChild(fila);
    console.log(`[UI] ‚úÖ Empleado agregado a la tabla: ${nombre}`);
}

// Funci√≥n para actualizar un empleado EXISTENTE (horas y/o estado)
function actualizarEmpleado(dni, horas, estado) {
    console.log(`[UI] üîÑ Actualizando empleado DNI: ${dni}, horas: ${horas}, estado: ${estado}`);
    const fila = document.querySelector(`tr[data-dni="${dni}"]`);
    if (!fila) {
        console.warn(`[UI] ‚ö†Ô∏è Empleado con DNI ${dni} no encontrado en tabla`);
        return;
    }
    
    // Actualizar estado
    const estadoIndicator = fila.querySelector('.estado-indicator');
    if (estadoIndicator) {
        const color = obtenerColorEstado(estado);
        estadoIndicator.style.background = color;
        estadoIndicator.setAttribute('data-estado', estado);
        
        // A√±adir animaci√≥n de pulso
        estadoIndicator.classList.add('changed');
        setTimeout(() => {
            estadoIndicator.classList.remove('changed');
        }, 600);
        
        console.log(`[UI] ‚úÖ Estado actualizado para ${dni}: ${estado} (color: ${color})`);
    }

}

// Polling para detectar cambios de estado
function iniciarPollingEstados() {
    setInterval(() => {
        fetch('/api/api/empleados_estado_actualizar')
            .then(response => response.json())
            .then(data => {
                console.log('[POLLING] üìä Respuesta recibida:', data);
                
                if (lastEmpleadosVersion === null) {
                    lastEmpleadosVersion = data.version;
                    console.log('[POLLING] üÜï Primera versi√≥n establecida:', lastEmpleadosVersion);
                    return;
                }
                
                if (data.version !== lastEmpleadosVersion) {
                    console.log(`[POLLING] üîî Nueva versi√≥n detectada: ${data.version} (anterior: ${lastEmpleadosVersion})`);
                    lastEmpleadosVersion = data.version;
                    
                    if (data.ultimo_cambio) {
                        console.log('[POLLING] üì¶ √öltimo cambio:', data.ultimo_cambio);
                        
                        if (data.ultimo_cambio.tipo === 'actualizado') {
                            const emp = data.ultimo_cambio.empleado;
                            console.log(`[POLLING] üîÑ Actualizando estado de ${emp.dni} a ${emp.estado}`);
                            actualizarEstadoEmpleado(emp.dni, emp.estado);
                        }
                    }
                } else {
                    console.log('[POLLING] ‚è∏Ô∏è Sin cambios (misma versi√≥n)');
                }
            })
            .catch(error => {
                console.error('[POLLING] ‚ùå Error:', error);
            });
    }, 2000); // Poll cada 2 segundos
}

// Funci√≥n para actualizar solo el estado de un empleado (para polling)
function actualizarEstadoEmpleado(dni, nuevoEstado) {
    console.log(`[UI-POLLING] üîÑ Actualizando estado de DNI: ${dni} a ${nuevoEstado}`);
    actualizarEmpleado(dni, undefined, nuevoEstado);
}

// Cargar TODOS los empleados al inicio
async function cargarEmpleadosInicial() {
    console.log('[CLIENTE] üöÄ Cargando empleados iniciales...');
    try {
        const response = await fetch('/api/empleados');
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const data = await response.json();
        
        if (data.success) {
            const tbody = document.querySelector("#tablaEmpleados tbody");
            tbody.innerHTML = '';
            
            if (data.empleados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No hay empleados...</td></tr>';
            } else {
                data.empleados.forEach(e => {
                    agregarEmpleado(e.nombre, e.dni, e.email, e.jornada, e.horas, e.estado);
                });
            }
            
            versionActual = data.version;
            console.log(`[CLIENTE] ‚úÖ Cargados (v${versionActual})`);
            esperarCambios();
        }
    } catch (error) {
        console.error('[CLIENTE] ‚ùå', error);
        setTimeout(cargarEmpleadosInicial, 3000);
    }
}

// Polling para detectar cambios de estado

// Long polling: esperar cambios (para nuevos empleados)
async function esperarCambios() {
    if (esperandoCambios) {
        console.warn('[CLIENTE] ‚ö†Ô∏è Ya hay una petici√≥n activa');
        return;
    }
    esperandoCambios = true;
    
    console.log(`[CLIENTE] üì° Esperando cambios... (versi√≥n: ${versionActual})`);
    
    try {
        const response = await fetch(`/api/empleados/esperar-cambios?version=${versionActual}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const data = await response.json();
        
        if (data.success && data.cambio) {
            console.log(`[POLLING] üîî Cambio: ${data.tipo}`);
            versionActual = data.version;
            
            if (data.tipo === 'nuevo') {
                const e = data.empleado;
                agregarEmpleado(e.nombre, e.dni, e.email, e.jornada, e.horas, e.estado);
            } else if (data.tipo === 'actualizado') {
                actualizarEmpleado(data.empleado.dni, data.empleado.estado);
            }
        }
    } catch (error) {
        console.error('[POLLING] ‚ùå', error);
        await new Promise(r => setTimeout(r, 3000));
    } finally {
        esperandoCambios = false;
        setTimeout(() => esperarCambios(), 100);
    }
}

// Iniciar al cargar la p√°gina
console.log('[CLIENTE] üé¨ Iniciando dashboard...');
cargarEmpleadosInicial();
</script>

{% endblock %}