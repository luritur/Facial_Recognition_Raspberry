{% extends "base.html" %}

{% block title %}Dashboard - Fichaje de Empleados{% endblock %}

{% block extra_css %}
<style>
    .header-section {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        margin-bottom: 30px;
    }
    .header-section h2 {
        margin: 0;
        color: #2c3e50;
        font-weight: 600;
    }
    .filters-bar {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        margin-bottom: 20px;
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        align-items: center;
    }
    .filters-bar select, .filters-bar input {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 8px 15px;
    }
    .employee-table {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        overflow: hidden;
    }
    .table {
        margin: 0;
    }
    .table thead {
        background-color: #f8f9fa;
    }
    .table th {
        border: none;
        color: #6c757d;
        font-weight: 600;
        font-size: 0.85rem;
        text-transform: uppercase;
        padding: 15px;
    }
    .table td {
        border-top: 1px solid #f0f0f0;
        padding: 15px;
        vertical-align: middle;
    }
    .employee-info {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .employee-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
    }
    .employee-name {
        font-weight: 600;
        color: #2c3e50;
        margin: 0;
    }
    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 500;
    }
    .status-online {
        background-color: #d4edda;
        color: #155724;
    }
    .status-online::before {
        content: '';
        width: 8px;
        height: 8px;
        background-color: #28a745;
        border-radius: 50%;
    }
    .progress-bar-custom {
        height: 8px;
        border-radius: 4px;
        background-color: #e9ecef;
        position: relative;
        overflow: hidden;
    }
    .progress-fill {
        height: 100%;
        border-radius: 4px;
        transition: width 0.3s;
    }
    .time-display {
        font-size: 0.9rem;
        color: #6c757d;
    }
    .task-badge {
        background-color: #e9ecef;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.85rem;
        color: #495057;
    }
    .completion-text {
        font-weight: 600;
        color: #2c3e50;
    }
    
    /* Animaci√≥n para cambios de estado */
    .estado-indicator {
        display: inline-block;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        border: 1px solid #555;
        transition: background-color 0.5s ease, transform 0.3s ease;
    }
    
    .estado-indicator.changed {
        animation: pulse 0.6s ease-in-out;
    }
    
    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.3); }
    }
</style>
{% endblock %}

{% block content %}
<div class="header-section">
    <h2>Empleados</h2>
</div>

<div class="filters-bar">
    <select class="form-select" style="width: auto;">
        <option>Centro</option>
    </select>
    <select class="form-select" style="width: auto;">
        <option>Departamento</option>
    </select>
    <button class="btn btn-light">
        <i class="bi bi-three-dots-vertical"></i>
    </button>
    <input type="search" class="form-control" placeholder="Buscar" style="max-width: 300px; margin-left: auto;">
    <button class="btn btn-outline-secondary">Configuraci√≥n gr√°f.</button>
</div>

<div class="employee-table">
    <table id="tablaEmpleados" class="table table-bordered table-striped">
        <thead class="table-dark">
            <tr>
                <th>Nombre</th>
                <th>DNI</th>
                <th>Email</th>
                <th>Jornada</th>
                <th>Progreso</th>
                <th>Estado</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td colspan="6" class="text-center text-muted">Cargando empleados...</td>
            </tr>
        </tbody>
    </table>
</div>

<script>
let versionActual = 0;
let esperandoCambios = false;
let lastEmpleadosVersion = null;  // Variable para polling de estados

// Funci√≥n para limpiar la fila vac√≠a
function limpiarFilaVacia() {
    const tbody = document.querySelector("#tablaEmpleados tbody");
    if (tbody && tbody.children.length === 1 &&
        tbody.children[0].children[0] &&
        tbody.children[0].children[0].colSpan >= 5) {
        tbody.innerHTML = "";
    }
}

// Funci√≥n para obtener el color seg√∫n el estado
function obtenerColorEstado(estado) {
    const colores = {
        "trabajando": "#ffc107",  // Amarillo
        "in": "#ffc107",          // Amarillo (alias)
        "out": "#dc3545",         // Rojo
        "completado": "#28a745",  // Verde
        "completada": "#28a745"   // Verde (alias)
    };
    return colores[estado] || "#6c757d"; // Gris por defecto
}

// Funci√≥n para agregar un empleado NUEVO
function agregarEmpleado(nombre, dni, email, jornada, horas, estado) {
    console.log(`[UI] ‚ûï Agregando empleado: ${nombre}`);
    limpiarFilaVacia();
    const tbody = document.querySelector("#tablaEmpleados tbody");
    if (!tbody) {
        console.error('[UI] ‚ùå No se encontr√≥ tbody');
        return;
    }

    const fila = document.createElement("tr");
    fila.setAttribute('data-dni', dni);
    fila.setAttribute('data-email', email);
    
    const progreso = Math.min((horas / jornada) * 100, 100).toFixed(1);
    const color = obtenerColorEstado(estado);

    fila.innerHTML = `
        <td>${nombre}</td>
        <td>${dni}</td>
        <td>${email}</td>
        <td>${jornada}h</td>
        <td>
            <div style="width:100%; background:#e5e5e5; border-radius:6px;">
                <div class="progress-fill-bar" style="width:${progreso}%; height:12px; background:#007bff; border-radius:6px; transition: width 0.5s ease;"></div>
            </div>
            <small class="horas-texto">${horas}/${jornada} h</small>
        </td>
        <td>
            <span class="estado-indicator" data-estado="${estado}" style="background:${color};"></span>
        </td>
    `;
    tbody.appendChild(fila);
    console.log(`[UI] ‚úÖ Empleado agregado a la tabla: ${nombre}`);
}

// Funci√≥n para actualizar un empleado EXISTENTE (horas y/o estado)
function actualizarEmpleado(dni, horas, estado) {
    console.log(`[UI] üîÑ Actualizando empleado DNI: ${dni}, horas: ${horas}, estado: ${estado}`);
    const fila = document.querySelector(`tr[data-dni="${dni}"]`);
    if (!fila) {
        console.warn(`[UI] ‚ö†Ô∏è Empleado con DNI ${dni} no encontrado en tabla`);
        return;
    }

    // Actualizar horas y progreso
    if (horas !== undefined) {
        const jornadaText = fila.cells[3].textContent;
        const jornada = parseFloat(jornadaText);
        const progreso = Math.min((horas / jornada) * 100, 100).toFixed(1);
        
        const progressBar = fila.querySelector('.progress-fill-bar');
        const horasTexto = fila.querySelector('.horas-texto');
        
        if (progressBar) {
            progressBar.style.width = `${progreso}%`;
        }
        if (horasTexto) {
            horasTexto.textContent = `${horas}/${jornada} h`;
        }
    }
    
    // Actualizar estado
    if (estado !== undefined) {
        const estadoIndicator = fila.querySelector('.estado-indicator');
        if (estadoIndicator) {
            const color = obtenerColorEstado(estado);
            estadoIndicator.style.background = color;
            estadoIndicator.setAttribute('data-estado', estado);
            
            // A√±adir animaci√≥n de pulso
            estadoIndicator.classList.add('changed');
            setTimeout(() => {
                estadoIndicator.classList.remove('changed');
            }, 600);
            
            console.log(`[UI] ‚úÖ Estado actualizado para ${dni}: ${estado} (color: ${color})`);
        }
    }
}

// Polling para detectar cambios de estado
function iniciarPollingEstados() {
    setInterval(() => {
        fetch('/api/api/empleados_estado_actualizar')
            .then(response => response.json())
            .then(data => {
                console.log('[POLLING] üìä Respuesta recibida:', data);
                
                if (lastEmpleadosVersion === null) {
                    lastEmpleadosVersion = data.version;
                    console.log('[POLLING] üÜï Primera versi√≥n establecida:', lastEmpleadosVersion);
                    return;
                }
                
                if (data.version !== lastEmpleadosVersion) {
                    console.log(`[POLLING] üîî Nueva versi√≥n detectada: ${data.version} (anterior: ${lastEmpleadosVersion})`);
                    lastEmpleadosVersion = data.version;
                    
                    if (data.ultimo_cambio) {
                        console.log('[POLLING] üì¶ √öltimo cambio:', data.ultimo_cambio);
                        
                        if (data.ultimo_cambio.tipo === 'actualizado') {
                            const emp = data.ultimo_cambio.empleado;
                            console.log(`[POLLING] üîÑ Actualizando estado de ${emp.dni} a ${emp.estado}`);
                            actualizarEstadoEmpleado(emp.dni, emp.estado);
                        }
                    }
                } else {
                    console.log('[POLLING] ‚è∏Ô∏è Sin cambios (misma versi√≥n)');
                }
            })
            .catch(error => {
                console.error('[POLLING] ‚ùå Error:', error);
            });
    }, 2000); // Poll cada 2 segundos
}

// Funci√≥n para actualizar solo el estado de un empleado (para polling)
function actualizarEstadoEmpleado(dni, nuevoEstado) {
    console.log(`[UI-POLLING] üîÑ Actualizando estado de DNI: ${dni} a ${nuevoEstado}`);
    actualizarEmpleado(dni, undefined, nuevoEstado);
}

// Cargar TODOS los empleados al inicio
async function cargarEmpleadosInicial() {
    console.log('[CLIENTE] üöÄ Cargando empleados iniciales...');
    try {
        const response = await fetch('/api/empleados');
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        console.log('[CLIENTE] üì¶ Datos recibidos:', data);
        
        if (data.success) {
            const tbody = document.querySelector("#tablaEmpleados tbody");
            tbody.innerHTML = '';
            
            if (data.empleados.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted">No hay empleados registrados a√∫n...</td>
                    </tr>
                `;
            } else {
                data.empleados.forEach(emp => {
                    agregarEmpleado(emp.nombre, emp.dni, emp.email, emp.jornada, emp.horas, emp.estado);
                });
            }
            
            versionActual = data.version;
            lastEmpleadosVersion = data.version;
            console.log(`[CLIENTE] ‚úÖ Empleados iniciales cargados. Versi√≥n: ${versionActual}`);
            
            // Iniciar polling para cambios de estado
            iniciarPollingEstados();
            
            // Iniciar long polling para nuevos empleados
            console.log('[CLIENTE] üîÑ Iniciando long polling...');
            esperarCambios();
        }
    } catch (error) {
        console.error('[CLIENTE] ‚ùå Error al cargar empleados:', error);
        setTimeout(cargarEmpleadosInicial, 3000);
    }
}

// Polling para detectar cambios de estado

// Long polling: esperar cambios (para nuevos empleados)
async function esperarCambios() {
    if (esperandoCambios) {
        console.warn('[CLIENTE] ‚ö†Ô∏è Ya hay una petici√≥n activa');
        return;
    }
    esperandoCambios = true;
    
    console.log(`[CLIENTE] üì° Esperando cambios... (versi√≥n: ${versionActual})`);
    
    try {
        const response = await fetch(`/api/empleados/esperar-cambios?version=${versionActual}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        console.log('[CLIENTE] üì¶ Respuesta recibida:', data);
        
        if (data.success && data.cambio) {
            console.log(`[CLIENTE] üîî ¬°Cambio detectado! Tipo: ${data.tipo}`, data.empleado);
            
            versionActual = data.version;
            
            // Procesar seg√∫n el tipo de cambio
            if (data.tipo === 'nuevo') {
                const emp = data.empleado;
                console.log('[CLIENTE] ‚ûï Procesando empleado nuevo:', emp);
                agregarEmpleado(emp.nombre, emp.dni, emp.email, emp.jornada, emp.horas, emp.estado);
            } else if (data.tipo === 'actualizado') {
                const emp = data.empleado;
                console.log('[CLIENTE] üîÑ Procesando actualizaci√≥n:', emp);
                actualizarEmpleado(emp.dni, emp.horas, emp.estado);
            }
        } else {
            console.log('[CLIENTE] ‚è∞ Sin cambios (timeout)');
        }
    } catch (error) {
        console.error('[CLIENTE] ‚ùå Error en long polling:', error);
        await new Promise(resolve => setTimeout(resolve, 3000));
    } finally {
        esperandoCambios = false;
        // Volver a esperar cambios
        setTimeout(() => esperarCambios(), 100);
    }
}

// Iniciar al cargar la p√°gina
console.log('[CLIENTE] üé¨ Iniciando dashboard...');
cargarEmpleadosInicial();
</script>

{% endblock %}