{% extends "base.html" %}

{% block title %}Dashboard - Fichaje de Empleados{% endblock %}

{% block extra_css %}
<style>
    .header-section {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        margin-bottom: 30px;
    }
    .header-section h2 {
        margin: 0;
        color: #2c3e50;
        font-weight: 600;
    }
    .employee-table {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        overflow: hidden;
    }
    .table {
        margin: 0;
    }
    .table thead {
        background-color: #f8f9fa;
    }
    .table th {
        border: none;
        color: #6c757d;
        font-weight: 600;
        font-size: 0.85rem;
        text-transform: uppercase;
        padding: 15px;
    }
    .table td {
        border-top: 1px solid #f0f0f0;
        padding: 15px;
        vertical-align: middle;
    }
    .progress-bar-custom {
        height: 12px;
        border-radius: 6px;
        background-color: #e9ecef;
        position: relative;
        overflow: hidden;
        width: 100%;
    }
    .progress-fill {
        height: 100%;
        border-radius: 6px;
        transition: width 0.5s ease, background-color 0.5s ease;
    }
    .time-display {
        font-size: 0.9rem;
        color: #6c757d;
        margin-top: 5px;
    }
    
    /* Estados con colores */
    .estado-indicator {
        display: inline-block;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: 2px solid #555;
        transition: background-color 0.5s ease, transform 0.3s ease;
    }
    
    .estado-indicator.changed {
        animation: pulse 0.6s ease-in-out;
    }
    
    /* Colores seg√∫n estado */
    .estado-out {
        background-color: #dc3545;
        border-color: #dc3545;
    }
    
    .estado-working {
        background-color: #ffc107;
        border-color: #ffc107;
        animation: pulse-working 2s infinite;
    }
    
    .estado-completado {
        background-color: #28a745;
        border-color: #28a745;
    }
    
    /* Colores de progreso */
    .progress-bajo {
        background: linear-gradient(90deg, #dc3545, #e74c3c);
    }
    
    .progress-medio {
        background: linear-gradient(90deg, #ffc107, #ffb300);
    }
    
    .progress-alto {
        background: linear-gradient(90deg, #17a2b8, #138496);
    }
    
    .progress-completado {
        background: linear-gradient(90deg, #28a745, #20c997);
    }
    
    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.3); }
    }
    
    @keyframes pulse-working {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
    }
    
    /* Badge de estado */
    .estado-badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
    }
    
    .badge-out {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .badge-working {
        background-color: #fff3cd;
        color: #856404;
    }
    
    .badge-completado {
        background-color: #d4edda;
        color: #155724;
    }
</style>
{% endblock %}

{% block content %}
<div class="header-section">
    <h2>üìä Panel de Fichaje</h2>
</div>

<div class="employee-table">
    <table id="tablaEmpleados" class="table table-bordered table-striped">
        <thead class="table-dark">
            <tr>
                <th>Nombre</th>
                <th>DNI</th>
                <th>Email</th>
                <th>Jornada</th>
                <th>Progreso</th>
                <th>Estado</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td colspan="6" class="text-center text-muted">Cargando empleados...</td>
            </tr>
        </tbody>
    </table>
</div>

<script>
let versionActual = 0;
let esperandoCambios = false;
let empleadosMap = new Map(); // Para tracking de actualizaciones en tiempo real

// Funci√≥n para limpiar la fila vac√≠a
function limpiarFilaVacia() {
    const tbody = document.querySelector("#tablaEmpleados tbody");
    if (tbody && tbody.children.length === 1 &&
        tbody.children[0].children[0] &&
        tbody.children[0].children[0].colSpan >= 5) {
        tbody.innerHTML = "";
    }
}

// Funci√≥n para obtener color de progreso seg√∫n porcentaje
function obtenerColorProgreso(progreso, jornada_completada) {
    if (jornada_completada) return 'progress-completado';
    if (progreso >= 75) return 'progress-alto';
    if (progreso >= 40) return 'progress-medio';
    return 'progress-bajo';
}

// Funci√≥n para obtener clase de estado
function obtenerClaseEstado(estado) {
    const clases = {
        "working": "estado-working",
        "out": "estado-out",
        "completado": "estado-completado"
    };
    return clases[estado] || "estado-out";
}

// Funci√≥n para obtener texto de estado
function obtenerTextoEstado(estado) {
    const textos = {
        "working": "Trabajando",
        "out": "Fuera",
        "completado": "Completado"
    };
    return textos[estado] || "Desconocido";
}

// Funci√≥n para agregar un empleado NUEVO
function agregarEmpleado(emp) {
    console.log(`[UI] ‚ûï Agregando empleado: ${emp.nombre}`);
    limpiarFilaVacia();
    const tbody = document.querySelector("#tablaEmpleados tbody");
    if (!tbody) {
        console.error('[UI] ‚ùå No se encontr√≥ tbody');
        return;
    }

    const fila = document.createElement("tr");
    fila.setAttribute('data-dni', emp.dni);
    
    const claseEstado = obtenerClaseEstado(emp.estado);
    const colorProgreso = obtenerColorProgreso(emp.progreso, emp.jornada_completada);

    fila.innerHTML = `
        <td>${emp.nombre}</td>
        <td>${emp.dni}</td>
        <td>${emp.email}</td>
        <td>${emp.jornada}h</td>
        <td>
            <div class="progress-bar-custom">
                <div class="progress-fill ${colorProgreso}" data-progreso="${emp.progreso}" style="width:${emp.progreso}%;"></div>
            </div>
            <small class="time-display">${emp.horas_formateadas} / ${emp.jornada}h</small>
        </td>
        <td>
            <div class="estado-badge badge-${emp.estado}">
                <span class="estado-indicator ${claseEstado}" data-estado="${emp.estado}"></span>
                <span>${obtenerTextoEstado(emp.estado)}</span>
            </div>
        </td>
    `;
    
    tbody.appendChild(fila);
    
    // Guardar en map para updates
    empleadosMap.set(emp.dni, emp);
    
    console.log(`[UI] ‚úÖ Empleado agregado: ${emp.nombre}`);
}

// Funci√≥n para actualizar un empleado EXISTENTE
// function actualizarEmpleado(emp) {
//     console.log(`[UI] üîÑ Actualizando empleado: ${emp.dni}`);
//     const fila = document.querySelector(`tr[data-dni="${emp.dni}"]`);
//     if (!fila) {
//         console.warn(`[UI] ‚ö†Ô∏è Empleado ${emp.dni} no encontrado en tabla`);
//         return;
//     }

//     const empleadoAnterior = empleadosMap.get(emp.dni);
//     const cambioEstado = empleadoAnterior && empleadoAnterior.estado !== emp.estado;
    
//     // Actualizar progreso
//     const progressBar = fila.querySelector('.progress-fill');
//     const timeDisplay = fila.querySelector('.time-display');
    
//     if (progressBar) {
//         const colorProgreso = obtenerColorProgreso(emp.progreso, emp.jornada_completada);
//         progressBar.style.width = `${emp.progreso}%`;
//         progressBar.className = `progress-fill ${colorProgreso}`;
//     }
    
//     if (timeDisplay) {
//         timeDisplay.textContent = `${emp.horas_formateadas} / ${emp.jornada}h`;
//     }
    
//     // Actualizar estado
//     const estadoBadge = fila.querySelector('.estado-badge');
//     const estadoIndicator = fila.querySelector('.estado-indicator');
    
//     if (estadoBadge && estadoIndicator) {
//         const claseEstado = obtenerClaseEstado(emp.estado);
        
//         // Actualizar clases
//         estadoBadge.className = `estado-badge badge-${emp.estado}`;
//         estadoIndicator.className = `estado-indicator ${claseEstado}`;
//         estadoIndicator.setAttribute('data-estado', emp.estado);
        
//         // Actualizar texto
//         const estadoTexto = estadoBadge.querySelector('span:last-child');
//         if (estadoTexto) {
//             estadoTexto.textContent = obtenerTextoEstado(emp.estado);
//         }
        
//         // Animaci√≥n si cambi√≥ el estado
//         if (cambioEstado) {
//             estadoIndicator.classList.add('changed');
//             setTimeout(() => {
//                 estadoIndicator.classList.remove('changed');
//             }, 600);
//         }
        
//         console.log(`[UI] ‚úÖ Estado actualizado: ${emp.estado}`);
//     }
    
//     // Actualizar en map
//     empleadosMap.set(emp.dni, emp);
// }

function actualizarEmpleado(empleado) {
    console.log('[CLIENTE] üîÑ Actualizando empleado:', empleado.dni);
    
    const fila = document.querySelector(`tr[data-dni="${empleado.dni}"]`);
    if (!fila) {
        console.warn('[CLIENTE] ‚ö†Ô∏è No se encontr√≥ la fila del empleado');
        return;
    }
    
    // Actualizar estado
    const estadoCell = fila.querySelector('.estado-cell');
    if (estadoCell) {
        const estadoBadge = estadoCell.querySelector('.estado-badge');
        if (estadoBadge) {
            estadoBadge.className = `estado-badge estado-${empleado.estado}`;
            estadoBadge.textContent = empleado.estado === 'trabajando' ? 'Trabajando' : 'Descansando';
        }
    }
    
    // Actualizar barra de progreso
    const progressBar = fila.querySelector('.progress-fill');
    if (progressBar) {
        const colorProgreso = obtenerColorProgreso(empleado.progreso, empleado.jornada_completada);
        progressBar.style.width = `${empleado.progreso}%`;
        progressBar.className = `progress-fill ${colorProgreso}`;
    }
    
    // Actualizar tiempo
    const timeDisplay = fila.querySelector('.time-display');
    if (timeDisplay) {
        timeDisplay.textContent = `${empleado.horas_formateadas} / ${empleado.jornada}h`;
    }
    
    // Actualizar en map
    empleadosMap.set(empleado.dni, empleado);
    
    console.log('[CLIENTE] ‚úÖ Empleado actualizado correctamente');
}

// Actualizaci√≥n autom√°tica: recargar datos del servidor cada 30 segundos
// let actualizacionAutomaticaInterval = null;

// function iniciarActualizacionAutomatica() {
//     // Limpiar intervalo anterior si existe
//     if (actualizacionAutomaticaInterval) {
//         clearInterval(actualizacionAutomaticaInterval);
//     }
    
//     // Actualizar cada 30 segundos
//     actualizacionAutomaticaInterval = setInterval(async () => {
//         console.log('[AUTO-UPDATE] üîÑ Actualizando datos...');
//         try {
//             const response = await fetch('/api/empleados');
//             if (!response.ok) throw new Error('Error al obtener datos');
            
//             const data = await response.json();
            
//             if (data.success && data.empleados) {
//                 // Actualizar cada empleado existente
//                 data.empleados.forEach(emp => {
//                     const fila = document.querySelector(`tr[data-dni="${emp.dni}"]`);
//                     if (fila) {
//                         // Actualizar solo si hay cambios (para evitar parpadeos)
//                         const progressBar = fila.querySelector('.progress-fill');
//                         const timeDisplay = fila.querySelector('.time-display');
                        
//                         if (progressBar) {
//                             const colorProgreso = obtenerColorProgreso(emp.progreso, emp.jornada_completada);
//                             progressBar.style.width = `${emp.progreso}%`;
//                             progressBar.className = `progress-fill ${colorProgreso}`;
//                         }
                        
//                         if (timeDisplay) {
//                             timeDisplay.textContent = `${emp.horas_formateadas} / ${emp.jornada}h`;
//                         }
                        
//                         // Actualizar en map
//                         empleadosMap.set(emp.dni, emp);
//                     }
//                 });
                
//                 console.log('[AUTO-UPDATE] ‚úÖ Datos actualizados');
//             }
//         } catch (error) {
//             console.error('[AUTO-UPDATE] ‚ùå Error:', error);
//         }
//     }, 30000); // 30 segundos
// }

// // Detener actualizaci√≥n autom√°tica cuando se cierra la p√°gina
// window.addEventListener('beforeunload', () => {
//     if (actualizacionAutomaticaInterval) {
//         clearInterval(actualizacionAutomaticaInterval);
//     }
// });

// Cargar TODOS los empleados al inicio
async function cargarEmpleadosInicial() {
    console.log('[CLIENTE] üöÄ Cargando empleados iniciales...');
    try {
        const response = await fetch('/api/empleados');
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        console.log('[CLIENTE] üì¶ Datos recibidos:', data);
        
        if (data.success) {
            const tbody = document.querySelector("#tablaEmpleados tbody");
            tbody.innerHTML = '';
            
            if (data.empleados.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted">No hay empleados registrados a√∫n...</td>
                    </tr>
                `;
            } else {
                data.empleados.forEach(emp => {
                    agregarEmpleado(emp);
                });
            }
            
            versionActual = data.version;
            console.log(`[CLIENTE] ‚úÖ Empleados iniciales cargados. Versi√≥n: ${versionActual}`);
            
            // Iniciar long polling
            console.log('[CLIENTE] üîÑ Iniciando long polling...');
            esperarCambios();
        }
    } catch (error) {
        console.error('[CLIENTE] ‚ùå Error al cargar empleados:', error);
        setTimeout(cargarEmpleadosInicial, 3000);
    }
}

// Long polling: esperar cambios
async function esperarCambios() {
    if (esperandoCambios) {
        console.warn('[CLIENTE] ‚ö†Ô∏è Ya hay una petici√≥n activa');
        return;
    }
    esperandoCambios = true;
    
    console.log(`[CLIENTE] üì° Esperando cambios... (versi√≥n: ${versionActual})`);
    
    try {
        const response = await fetch(`/api/empleados/esperar-cambios?version=${versionActual}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        console.log('[CLIENTE] üì¶ Respuesta recibida:', data);
        
        if (data.success && data.cambio) {
            console.log(`[CLIENTE] üîî ¬°Cambio detectado! Tipo: ${data.tipo}`, data.empleado);
            
            versionActual = data.version;
            
            if (data.tipo === 'nuevo') {
                agregarEmpleado(data.empleado);
            } else if (data.tipo === 'actualizado') {
                actualizarEmpleado(data.empleado);
            }
        } else {
            console.log('[CLIENTE] ‚è∞ Sin cambios (timeout)');
        }
    } catch (error) {
        console.error('[CLIENTE] ‚ùå Error en long polling:', error);
        await new Promise(resolve => setTimeout(resolve, 3000));
    } finally {
        esperandoCambios = false;
        setTimeout(() => esperarCambios(), 100);
    }
}

// Iniciar al cargar la p√°gina
console.log('[CLIENTE] üé¨ Iniciando dashboard...');
cargarEmpleadosInicial();

// Iniciar actualizaci√≥n autom√°tica
iniciarActualizacionAutomatica();
</script>

{% endblock %}