{% extends "base.html" %}

{% block title %}Registro de Empleados{% endblock %}

{% block extra_css %}
<style>
        .delete-employee-btn {
            background: #e74c3c;
            border: none;
            color: white;
            font-size: 1.3rem;
            border-radius: 10px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(231,76,60,0.10);
            transition: transform 0.18s, box-shadow 0.18s;
            cursor: pointer;
            margin-top: 8px;
        }
        .delete-employee-btn:hover {
            transform: translateY(-4px) scale(1.08);
            box-shadow: 0 6px 18px rgba(231,76,60,0.18);
            background: #c0392b;
        }
        @media (max-width: 500px) {
            .delete-employee-btn {
                width: 32px;
                height: 32px;
                font-size: 1.1rem;
            }
        }
    .header-section {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        margin-bottom: 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .header-section h2 {
        margin: 0;
        color: #2c3e50;
        font-weight: 600;
    }
    .employees-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 80px;
    }
    .employee-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        padding: 20px;
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: pointer;
    }
    .employee-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    }
    .employee-card-header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 15px;
    }
    .employee-card-avatar {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        font-weight: bold;
    }
    .employee-card-info h5 {
        margin: 0;
        color: #2c3e50;
        font-weight: 600;
    }
    .employee-card-info p {
        margin: 5px 0 0;
        color: #6c757d;
        font-size: 0.9rem;
    }
    .employee-card-details {
        border-top: 1px solid #f0f0f0;
        padding-top: 15px;
    }
    .detail-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        font-size: 0.9rem;
    }
    .detail-label {
        color: #6c757d;
    }
    .detail-value {
        color: #2c3e50;
        font-weight: 500;
    }
    
    /* Bot√≥n flotante */
    .add-employee-btn {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        color: white;
        border: none;
        box-shadow: 0 4px 16px rgba(52,152,219,0.4);
        font-size: 1.8rem;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        z-index: 999;
    }
    .add-employee-btn:hover {
        transform: scale(1.1) rotate(90deg);
        box-shadow: 0 6px 20px rgba(52,152,219,0.5);
    }
    
    /* Modal */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s;
    }
    .modal-overlay.show {
        display: flex;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    .modal-content-custom {
        background: white;
        border-radius: 16px;
        width: 90%;
        max-width: 550px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        animation: slideUp 0.3s;
    }
    
    @keyframes slideUp {
        from {
            transform: translateY(50px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
    
    .modal-header-custom {
        padding: 25px;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        color: white;
        border-radius: 16px 16px 0 0;
    }
    .modal-header-custom h3 {
        margin: 0;
        font-weight: 600;
        font-size: 1.3rem;
    }
    .close-btn {
        background: rgba(255,255,255,0.2);
        border: none;
        font-size: 1.5rem;
        color: white;
        cursor: pointer;
        padding: 0;
        width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background 0.3s;
    }
    .close-btn:hover {
        background: rgba(255,255,255,0.3);
    }
    
    /* Barra de progreso */
    .progress-container {
        padding: 20px 25px 10px;
        background: #f8f9fa;
    }
    .progress-bar-custom {
        width: 100%;
        height: 6px;
        background: #e0e0e0;
        border-radius: 3px;
        overflow: hidden;
        margin-bottom: 10px;
    }
    .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #3498db 0%, #2980b9 100%);
        transition: width 0.4s ease;
    }
    .step-indicator {
        text-align: center;
        color: #6c757d;
        font-size: 0.9rem;
        font-weight: 500;
    }
    
    /* Pasos */
    .modal-body-custom {
        padding: 30px 25px;
    }
    .step {
        display: none;
    }
    .step.active {
        display: block;
        animation: fadeIn 0.3s;
    }
    .step h4 {
        margin: 0 0 20px 0;
        color: #2c3e50;
        font-size: 1.2rem;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    .form-label {
        display: block;
        margin-bottom: 8px;
        color: #2c3e50;
        font-weight: 500;
        font-size: 0.95rem;
    }
    .form-control {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.3s;
    }
    .form-control:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 0 3px rgba(52,152,219,0.1);
    }
    
    /* Select personalizado */
    select.form-control {
        cursor: pointer;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        padding-right: 35px;
        appearance: none;
    }
    
    /* Confirmaci√≥n */
    .confirmation-box {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        border-left: 4px solid #3498db;
    }
    .confirmation-box .conf-row {
        display: flex;
        margin-bottom: 12px;
    }
    .confirmation-box .conf-row:last-child {
        margin-bottom: 0;
    }
    .conf-label {
        font-weight: 600;
        color: #2c3e50;
        min-width: 100px;
    }
    .conf-value {
        color: #495057;
    }
    .info-text {
        margin-top: 20px;
        padding: 15px;
        background: #e7f3ff;
        border-radius: 8px;
        color: #004085;
        font-size: 0.9rem;
        line-height: 1.5;
    }
    
    /* Captura */
    .camera-preview {
        width: 100%;
        height: 300px;
        background: #000;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 20px;
        overflow: hidden;
        position: relative;
    }
    .camera-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .camera-placeholder {
        color: #999;
        font-size: 1.1rem;
    }
    
    .countdown {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 6rem;
        font-weight: bold;
        color: white;
        text-shadow: 0 4px 8px rgba(0,0,0,0.5);
        animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { transform: translate(-50%, -50%) scale(1); }
        50% { transform: translate(-50%, -50%) scale(1.1); }
    }
    
    .alert {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        font-size: 0.95rem;
    }
    .alert-info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
    }
    .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    .alert-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    /* Contador de captura */
    .capture-timer {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(52, 152, 219, 0.95);
        color: white;
        padding: 15px 20px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: bold;
        animation: timerPulse 1s infinite;
    }
    
    @keyframes timerPulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }
    
    .timer-icon {
        font-size: 1.5rem;
    }
    
    .timer-text {
        font-size: 1.8rem;
        letter-spacing: 1px;
    }
    
    /* Footer con botones */
    .modal-footer-custom {
        padding: 20px 25px;
        border-top: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        gap: 10px;
    }
    .btn {
        padding: 10px 24px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        font-size: 1rem;
        transition: all 0.3s;
    }
    .btn-secondary {
        background: #6c757d;
        color: white;
    }
    .btn-secondary:hover {
        background: #5a6268;
    }
    .btn-primary {
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        color: white;
    }
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(52,152,219,0.4);
    }
    .btn-success {
        background: #28a745;
        color: white;
    }
    .btn-success:hover {
        background: #218838;
    }
    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .header-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    /* Contenedor del badge + bot√≥n */
    .header-buttons {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    /* Bot√≥n peque√±o estilo header */
    .entrenar-modelo-btn{
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        color: white;
        border: none;
        font-size: 1.3rem;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        box-shadow: 0 4px 10px rgba(52,152,219,0.3);
        transition: transform 0.2s ease;
    }
    .entrenar-modelo-btn:hover {
        transform: scale(1.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="header-section">
    <h2>Registro de Empleados</h2>
    <div class="header-buttons">
        <span class="badge bg-secondary" style="padding: 8px 15px; font-size: 0.9rem;">
            Total: {{ employees|length if employees else 0 }} empleados
        </span>
        <button class="entrenar-modelo-btn" onclick="entrenarModelo()">ü§ñ</button>
    </div>
</div>

<div class="employees-grid">
    {% if employees %}
        {% for employee in employees %}
        <div class="employee-card">
            <div class="employee-card-header">
                <div class="employee-card-avatar">
                    {{ employee.nombre[0]|upper }}{{ employee.nombre.split()[1][0]|upper if employee.nombre.split()|length > 1 else '' }}
                </div>
                <div class="employee-card-info">
                    <h5>{{ employee.nombre }}</h5>
                    <p>{{ employee.dni }}</p>
                </div>
            </div>
            <div class="employee-card-details">
                <div class="detail-row">
                    <span class="detail-label">DNI:</span>
                    <span class="detail-value">{{ employee.dni }}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Email:</span>
                    <span class="detail-value">{{ employee.email }}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Jornada:</span>
                    <span class="detail-value">
                        {% if employee.jornada == 8 %}Jornada Completa{% elif employee.jornada == 4 %}Jornada Parcial{% elif employee.jornada == 6 %}Jornada Intensiva{% else %}{{ employee.jornada }}{% endif %}
                    </span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Estado:</span>
                    <span class="detail-value">‚úÖ Registrado</span>
                </div>
                <div class="detail-row" style="justify-content: flex-end;">
                    <button class="delete-employee-btn" title="Eliminar empleado" onclick="deleteEmployee('{{ employee.dni }}')">
                        üóëÔ∏è
                    </button>
                </div>
            </div>
        <script>
        function deleteEmployee(dni) {
            if (!confirm('¬øSeguro que quieres eliminar este empleado?')) return;
            
            fetch('/api/api/delete_employee', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ dni: dni })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'ok') {
                    location.reload();
                } else {
                    alert('‚ùå Error al eliminar: ' + data.message);
                }
            })
            .catch(err => alert('‚ùå Error al eliminar: ' + err));
        }
        </script>
        </div>
        {% endfor %}
    {% else %}
        <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px;">
            <p style="font-size: 1.2rem; color: #6c757d;">
                No hay empleados registrados a√∫n.<br>
                Haz clic en el bot√≥n + para agregar el primero.
            </p>
        </div>
    {% endif %}
</div>

<button class="add-employee-btn" onclick="openModal()">+</button>

<div class="modal-overlay" id="addEmployeeModal">
    <div class="modal-content-custom">
        <div class="modal-header-custom">
            <h3>‚ûï Registrar Nuevo Empleado</h3>
            <button class="close-btn" onclick="closeModal()">&times;</button>
        </div>
        
        <div class="progress-container">
            <div class="progress-bar-custom">
                <div class="progress-bar-fill" id="progressBar" style="width: 33%;"></div>
            </div>
            <div class="step-indicator" id="stepIndicator">Paso 1 de 3</div>
        </div>
        
        <div class="modal-body-custom">
            <div id="step1" class="step active">
                <h4>üìù Datos del Empleado</h4>
                <div class="form-group">
                    <label class="form-label">Nombre completo *</label>
                    <input type="text" id="nombre" class="form-control" placeholder="Ej: Juan P√©rez Garc√≠a" required>
                </div>
                <div class="form-group">
                    <label class="form-label">DNI/NIE *</label>
                    <input type="text" id="dni" class="form-control" placeholder="Ej: 12345678A" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email *</label>
                    <input type="email" id="email" class="form-control" placeholder="Ej: juan.perez@empresa.com" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Tipo de Jornada *</label>
                    <select id="jornada" class="form-control" required>
                        <option value="">Selecciona una jornada...</option>
                        <option value="8">Jornada Completa</option>
                        <option value="4">Jornada Parcial</option>
                        <option value="6">Jornada Intensiva</option>
                    </select>
                </div>
            </div>
            <div id="step2" class="step">
                <h4>‚úÖ Confirma los datos</h4>
                <div class="confirmation-box">
                    <div class="conf-row">
                        <span class="conf-label">Nombre:</span>
                        <span class="conf-value" id="confirmNombre">-</span>
                    </div>
                    <div class="conf-row">
                        <span class="conf-label">DNI:</span>
                        <span class="conf-value" id="confirmDni">-</span>
                    </div>
                    <div class="conf-row">
                        <span class="conf-label">Email:</span>
                        <span class="conf-value" id="confirmEmail">-</span>
                    </div>
                    <div class="conf-row">
                        <span class="conf-label">Jornada:</span>
                        <span class="conf-value" id="confirmJornada">-</span>
                    </div>
                </div>
                <div class="info-text">
                    ‚ÑπÔ∏è En el siguiente paso, la c√°mara capturar√° autom√°ticamente tu rostro durante <strong>8 segundos</strong>. 
                    Aseg√∫rate de estar bien iluminado y mirando directamente a la c√°mara.
                    <br>
                    <strong>‚ö†Ô∏è RECOMENDABLE:</strong> para que el sistema registre mejor tu cara, primero mira fijamente a la c√°mara y despu√©s vete moviendo la cara en c√≠rculos.
                </div>
            </div>
            <div id="step3" class="step">
                <h4>üì∏ Captura de Rostro</h4>
                
                <div id="captureStatus">
                    </div>
                
                <div style="position: relative;">
                    <div class="camera-preview" id="cameraPreview">
                        <img id="videoFeed" class="video-feed" src="{{ url_for('video.video_feed') }}" alt="C√°mara en vivo">
                        <div class="camera-placeholder" style="display: none;">üìπ C√°mara lista</div>
                        <div id="countdown" class="countdown" style="display: none;">3</div>
                    </div>
                    
                    <div id="captureTimer" class="capture-timer" style="display: none;">
                        <div class="timer-icon">‚è±Ô∏è</div>
                        <div class="timer-text">
                            <span id="timerSeconds">8</span>s
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="modal-footer-custom">
            <button type="button" class="btn btn-secondary" id="btnBack" onclick="prevStep()" style="display: none;">
                ‚Üê Atr√°s
            </button>
            <div style="flex: 1;"></div>
            <button type="button" class="btn btn-secondary" onclick="closeModal()">
                Cancelar
            </button>
            <button type="button" class="btn btn-primary" id="btnNext" onclick="nextStep()">
                Siguiente ‚Üí
            </button>
            <button type="button" class="btn btn-success" id="btnCapture" onclick="startCapture()" style="display: none;">
                üé• Iniciar Captura
            </button>
        </div>
    </div>
</div>

<script>
let currentStep = 1;
let captureInProgress = false;

function openModal() {
    document.getElementById('addEmployeeModal').classList.add('show');
    resetModal();
}

function entrenarModelo() {
    
    fetch('api/api/entrenarModelo', { method: 'POST' })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => { throw data });
            }
            return response.json();
        })
        .then(data => {
            console.log('OK:', data);
            // Iniciar polling de progreso
            mostrarModalProgreso();
            iniciarPollingProgreso();
        })
        .catch(err => {
            console.error('Error:', err);
            cerrarModalProgreso();
            alert('‚ùå No hay empleados registrados con los que entrenar el modelo');
        });
}

function mostrarModalProgreso() {
    // Crear modal si no existe
    if (!document.getElementById('modalProgreso')) {
        const modalHTML = `
            <div id="modalProgreso" style="
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
            ">
                <div style="
                    background: white;
                    padding: 30px;
                    border-radius: 12px;
                    min-width: 400px;
                    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                ">
                    <h3 style="margin: 0 0 20px 0; color: #2c3e50;">ü§ñ Entrenando Modelo</h3>
                    <div id="mensajeProgreso" style="
                        margin-bottom: 15px;
                        color: #6c757d;
                        font-size: 0.95rem;
                    ">Iniciando...</div>
                    <div style="
                        width: 100%;
                        height: 30px;
                        background: #e9ecef;
                        border-radius: 15px;
                        overflow: hidden;
                        position: relative;
                    ">
                        <div id="barraProgreso" style="
                            height: 100%;
                            background: linear-gradient(90deg, #3498db, #2980b9);
                            width: 0%;
                            transition: width 0.3s ease;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: white;
                            font-weight: bold;
                            font-size: 0.85rem;
                        ">0%</div>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
    }
    document.getElementById('modalProgreso').style.display = 'flex';
}

function cerrarModalProgreso() {
    const modal = document.getElementById('modalProgreso');
    if (modal) {
        modal.style.display = 'none';
    }
}

function iniciarPollingProgreso() {
    const intervalo = setInterval(() => {
        fetch('/api/api/entrenamiento/progreso')
            .then(response => response.json())
            .then(data => {
                const barra = document.getElementById('barraProgreso');
                const mensaje = document.getElementById('mensajeProgreso');
                
                if (barra && mensaje) {
                    barra.style.width = data.progreso + '%';
                    barra.textContent = data.progreso + '%';
                    mensaje.textContent = data.mensaje;
                }
                
                // Si termin√≥ o hubo error
                if (!data.entrenando) {
                    clearInterval(intervalo);
                    
                    if (data.progreso === 100) {
                        // √âxito
                        setTimeout(() => {
                            cerrarModalProgreso();
                            location.reload();
                        }, 1500);
                    } else if (data.progreso === -1) {
                        // Error
                        cerrarModalProgreso();
                        alert('‚ùå Error en el entrenamiento:\n' + data.mensaje);
                    }
                }
            })
            .catch(err => {
                console.error('Error en polling:', err);
                clearInterval(intervalo);
                cerrarModalProgreso();
            });
    }, 500); // Actualizar cada 500ms
}


function closeModal() {
    if (captureInProgress) {
        if (!confirm('‚ö†Ô∏è La captura est√° en proceso. ¬øEst√°s seguro de cancelar?')) {
            return;
        }
        // Llama al endpoint para cancelar registro
        fetch('/api/api/cancelar_registro', { method: 'POST' })
            .then(() => stopCapture());
    }
    document.getElementById('addEmployeeModal').classList.remove('show');
    resetModal();
}

function resetModal() {
    currentStep = 1;
    showStep(1);
    document.getElementById('nombre').value = '';
    document.getElementById('dni').value = '';
    document.getElementById('email').value = '';
    document.getElementById('jornada').value = '';
    document.getElementById('captureStatus').innerHTML = '';
    document.getElementById('videoFeed').style.display = 'none';
    document.getElementById('countdown').style.display = 'none';
    document.getElementById('captureTimer').style.display = 'none';
    document.querySelector('.camera-placeholder').style.display = 'flex';
    captureInProgress = false;
}

function showStep(step) {
    // Ocultar todos los pasos
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    
    // Mostrar paso actual
    document.getElementById('step' + step).classList.add('active');
    
    // Actualizar barra de progreso
    const progress = (step / 3) * 100;
    document.getElementById('progressBar').style.width = progress + '%';
    document.getElementById('stepIndicator').textContent = `Paso ${step} de 3`;
    
    // Mostrar/ocultar botones seg√∫n el paso
    const btnBack = document.getElementById('btnBack');
    const btnNext = document.getElementById('btnNext');
    const btnCapture = document.getElementById('btnCapture');
    
    if (step === 1) {
        btnBack.style.display = 'none';
        btnNext.style.display = 'block';
        btnCapture.style.display = 'none';
        btnNext.textContent = 'Siguiente ‚Üí';
    } else if (step === 2) {
        btnBack.style.display = 'block';
        btnNext.style.display = 'block';
        btnCapture.style.display = 'none';
        btnNext.textContent = 'Preparar C√°mara ‚Üí';
    } else if (step === 3) {
        btnBack.style.display = 'block';
        btnNext.style.display = 'none';
        btnCapture.style.display = 'block';
    }
    
    currentStep = step;
}// Variable para guardar si el reconocimiento estaba activo antes del registro
let recognitionWasActive = false;

// üîÑ Reiniciar reconocimiento al cerrar la ventana/pesta√±a
window.addEventListener('beforeunload', function(e) {
    if (recognitionWasActive) {
        console.log('üîÑ Ventana cerr√°ndose. Reiniciando reconocimiento...');
        
        // Usar sendBeacon para enviar la petici√≥n de forma fiable al cerrar
        const data = new Blob([JSON.stringify({})], { type: 'application/json' });
        navigator.sendBeacon('/api/api/initrecognition', data);
    }
});

// Detener reconocimiento
function stopRecognition() {
    console.log('üî¥ [STOP] Bot√≥n de detener presionado');
    fetch('/api/api/stoprecognition', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            console.log('‚úÖ [STOP] Reconocimiento detenido:', data);
            isPolling = false;
            
            // ‚úÖ Limpiar estado de memoria
            recognitionWasActive = false;
            
            document.getElementById('statusText').textContent = 'Reconocimiento detenido';
        })
        .catch(err => console.error('‚ùå [STOP] Error al detener reconocimiento:', err));
}

function nextStep() {
    if (currentStep === 1) {
        // Validar datos
        const nombre = document.getElementById('nombre').value.trim();
        const dni = document.getElementById('dni').value.trim();
        const email = document.getElementById('email').value.trim();
        const jornada = document.getElementById('jornada').value;

        if (!nombre) {
            alert('‚ö†Ô∏è Por favor, introduce el nombre completo');
            return;
        }

        if (!dni) {
            alert('‚ö†Ô∏è Por favor, introduce el DNI/NIE');
            return;
        }

        // Validaci√≥n b√°sica de DNI espa√±ol
        const dniRegex = /^[0-9]{8}[A-Z]$/i;
        if (!dniRegex.test(dni)) {
            alert('‚ö†Ô∏è Formato de DNI inv√°lido. Debe ser 8 n√∫meros seguidos de una letra (Ej: 12345678A)');
            return;
        }

        if (!email) {
            alert('‚ö†Ô∏è Por favor, introduce el email');
            return;
        }

        // Validaci√≥n b√°sica de email
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            alert('‚ö†Ô∏è Formato de email inv√°lido');
            return;
        }

        if (!jornada) {
            alert('‚ö†Ô∏è Por favor, selecciona el tipo de jornada');
            return;
        }

        // Comprobar si ya existe usuario con ese email o dni
        fetch('/api/api/check_user_exists', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: email, dni: dni })
        })
        .then(response => response.json())
        .then(data => {
            if (data.exists) {
                if (data.field === 'email') {
                    alert('‚ö†Ô∏è Ya existe un usuario con ese email.');
                } else if (data.field === 'dni') {
                    alert('‚ö†Ô∏è Ya existe un usuario con ese DNI.');
                }
                return;
            }
            // Actualizar confirmaci√≥n
            document.getElementById('confirmNombre').textContent = nombre;
            document.getElementById('confirmDni').textContent = dni.toUpperCase();
            document.getElementById('confirmEmail').textContent = email;
            // Convertir jornada a texto legible
            const jornadaTexto = {
                '8': 'Jornada Completa',
                '4': 'Jornada Parcial',
                '6': 'Jornada Intensiva'
            };
            document.getElementById('confirmJornada').textContent = jornadaTexto[jornada];
            showStep(2);
        })
        .catch(err => {
            alert('Error comprobando usuario: ' + err);
        });
    } else if (currentStep === 2) {
        // üîç Comprobar si el reconocimiento est√° activo antes de continuar
        fetch('/api/api/recognition_status')
            .then(response => response.json())
            .then(data => {
                if (data.active) {
                    console.log('‚ö†Ô∏è Reconocimiento activo detectado. Deteni√©ndolo...');
                    recognitionWasActive = true;
                    
                    // Detener el reconocimiento
                    return fetch('/api/api/stoprecognition', { method: 'POST' })
                        .then(response => response.json())
                        .then(() => {
                            console.log('‚úÖ Reconocimiento detenido para iniciar captura');
                            proceedToCapture();
                        });
                } else {
                    console.log('‚úÖ Reconocimiento no activo. Continuando...');
                    recognitionWasActive = false;
                    proceedToCapture();
                }
            })
            .catch(err => {
                console.error('‚ùå Error comprobando estado de reconocimiento:', err);
                // Continuar de todos modos
                proceedToCapture();
            });
    }
}

// Funci√≥n auxiliar para proceder a la captura
function proceedToCapture() {
    setTimeout(() => {
        console.log("Preparando captura de rostro");
    }, 2000);
    
    // Preparar c√°mara
    showStep(3);
    
    // Mostrar video feed despu√©s de un momento
    setTimeout(() => {
        document.getElementById('videoFeed').style.display = 'block';
        document.querySelector('.camera-placeholder').style.display = 'none';
    }, 500);
}

function prevStep() {
    if (captureInProgress) {
        stopCapture();
    }
    
    if (currentStep > 1) {
        showStep(currentStep - 1);
    }
}

function startCapture() {
    captureInProgress = true;
    const nombre = document.getElementById('nombre').value.trim();
    const dni = document.getElementById('dni').value.trim();
    const email = document.getElementById('email').value.trim();
    const jornada = document.getElementById('jornada').value;
    
    // Deshabilitar botones
    document.getElementById('btnCapture').disabled = true;
    document.getElementById('btnBack').disabled = true;
    
    // Mostrar mensaje
    document.getElementById('captureStatus').innerHTML = 
        '<div class="alert alert-info">‚è≥ Preparando captura...</div>';
    
    // Countdown 3, 2, 1
    let count = 3;
    const countdownEl = document.getElementById('countdown');
    countdownEl.style.display = 'block';
    countdownEl.textContent = count;
    
    const countInterval = setInterval(() => {
        count--;
        if (count > 0) {
            countdownEl.textContent = count;
        } else {
            clearInterval(countInterval);
            countdownEl.textContent = 'üì∏';
            
            // Iniciar captura real
            setTimeout(() => {
                actualCapture(nombre, dni, email, jornada);
            }, 500);
        }
    }, 1000);
}

function actualCapture(nombre, dni, email, jornada) {
    document.getElementById('captureStatus').innerHTML = 
        '<div class="alert alert-info">üì∏ Capturando rostro... Mant√©n la mirada fija en la c√°mara</div>';
    
    // Mostrar y animar el contador de 8 segundos
    const captureTimerEl = document.getElementById('captureTimer');
    const timerSecondsEl = document.getElementById('timerSeconds');
    captureTimerEl.style.display = 'flex';
    
    let timeLeft = 8;
    timerSecondsEl.textContent = timeLeft;
    
    const timerInterval = setInterval(() => {
        timeLeft--;
        if (timeLeft > 0) {
            timerSecondsEl.textContent = timeLeft;
        } else {
            clearInterval(timerInterval);
            captureTimerEl.style.display = 'none';
        }
    }, 1000);
    
    // Llamar a la API de registro incluyendo email y jornada
    fetch('/api/api/registrar', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            nombre: nombre,
            dni: dni,
            email: email,
            jornada: parseInt(jornada),
            duracion: 3
        })
    })
    .then(response => response.json())
    .then(data => {
        clearInterval(timerInterval);
        captureTimerEl.style.display = 'none';
        document.getElementById('countdown').style.display = 'none';
        
        if (data.status === 'ok') {
            document.getElementById('captureStatus').innerHTML = 
                '<div class="alert alert-success">‚úÖ ' + data.message + '</div>';
            
            // ‚úÖ Registro completado - recargar p√°gina
            // El reconocimiento se reiniciar√° autom√°ticamente al cerrar la ventana
            // gracias al evento beforeunload si estaba activo
            document.getElementById('captureStatus').innerHTML += 
                '<div class="alert alert-info">Redirigiendo...</div>';
            
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            throw new Error(data.message || 'Error desconocido');
        }
    })
    .catch(error => {
        clearInterval(timerInterval);
        captureTimerEl.style.display = 'none';
        document.getElementById('countdown').style.display = 'none';
        document.getElementById('captureStatus').innerHTML = 
            '<div class="alert alert-error">‚ùå Error: ' + error.message + '</div>';
        
        // Rehabilitar botones
        document.getElementById('btnCapture').disabled = false;
        document.getElementById('btnBack').disabled = false;
        captureInProgress = false;
    });
}

function stopCapture() {
    captureInProgress = false;
    fetch('/api/registrar/stop', { method: 'POST' })
        .catch(e => console.error('Error deteniendo captura:', e));
}

// Cerrar modal al hacer click fuera
document.getElementById('addEmployeeModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeModal();
    }
});

// Cerrar con tecla ESC
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && document.getElementById('addEmployeeModal').classList.contains('show')) {
        closeModal();
    }
});

// Enter en los inputs avanza al siguiente paso
document.getElementById('nombre').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        document.getElementById('dni').focus();
    }
});

document.getElementById('dni').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        document.getElementById('email').focus();
    }
});

document.getElementById('email').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        document.getElementById('jornada').focus();
    }
});

document.getElementById('jornada').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        nextStep();
    }
});
</script>
{% endblock %}